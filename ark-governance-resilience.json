{
  "module_name": "Governance, Rate Limiting & Error Handling",
  "purpose": "Ensure reliable, secure, and compliant operations with robust error handling",
  "version": "2.0",

  "governance_framework": {
    "purpose": "Define rules, policies, and controls for ARK Intelligence operations",

    "access_control": {
      "role_based_permissions": {
        "admin": {
          "can_do": [
            "Configure system settings",
            "Manage integrations",
            "View all analytics",
            "Export all data",
            "Manage user permissions",
            "Access audit logs"
          ],
          "cannot_do": [
            "Delete audit trails",
            "Bypass compliance checks"
          ]
        },

        "senior_recruiter": {
          "can_do": [
            "Analyze candidates and JDs",
            "Generate reports",
            "Use all recruiting features",
            "View team analytics",
            "Export candidate data",
            "Manage own pipeline"
          ],
          "cannot_do": [
            "Change system settings",
            "Access other recruiters' data (unless shared)",
            "Bypass bias detection warnings"
          ]
        },

        "recruiter": {
          "can_do": [
            "Analyze candidates and JDs",
            "Generate basic reports",
            "Use core recruiting features",
            "View own analytics"
          ],
          "cannot_do": [
            "Access team-wide analytics",
            "Export bulk data",
            "Override system recommendations"
          ]
        },

        "hiring_manager": {
          "can_do": [
            "View candidate analyses",
            "Provide feedback",
            "View reports for their roles",
            "Request analyses"
          ],
          "cannot_do": [
            "Access full candidate database",
            "Modify scoring criteria",
            "See salary/rate information"
          ]
        },

        "read_only": {
          "can_do": [
            "View shared reports",
            "Read documentation"
          ],
          "cannot_do": [
            "Analyze new candidates",
            "Generate reports",
            "Export data"
          ]
        }
      },

      "data_access_controls": {
        "pii_protection": {
          "rule": "Personally Identifiable Information requires explicit permission",
          "pii_fields": [
            "Full name",
            "Email address",
            "Phone number",
            "Home address",
            "SSN/Tax ID",
            "Date of birth",
            "Photo"
          ],
          "controls": [
            "Mask by default (show only when needed)",
            "Log all access to PII fields",
            "Require business justification for bulk export",
            "Auto-redact PII in screenshots/reports unless authorized"
          ]
        },

        "salary_data_protection": {
          "rule": "Salary/rate information is confidential",
          "controls": [
            "Show only to authorized roles (recruiters, admins)",
            "Hide from hiring managers unless explicitly shared",
            "Never include in public reports or emails",
            "Mask in logs and audit trails"
          ]
        },

        "candidate_confidentiality": {
          "rule": "Candidate data is confidential to the hiring process",
          "controls": [
            "Limit access to recruiters working on that role",
            "Require NDA acknowledgment for sensitive roles",
            "Auto-expire access after role is filled",
            "Alert if candidate data accessed outside normal workflow"
          ]
        }
      }
    },

    "operational_policies": {
      "anti_abuse_policies": {
        "no_bulk_scraping": {
          "rule": "Prevent mass data extraction for non-business purposes",
          "detection": "Flag if user exports >100 candidates in 24 hours",
          "action": "Require admin approval + business justification"
        },

        "no_discriminatory_use": {
          "rule": "ARK cannot be used to discriminate against protected classes",
          "detection": "Bias detection alerts, audit pattern analysis",
          "action": "Block discriminatory queries + alert compliance team"
        },

        "no_candidate_harassment": {
          "rule": "ARK-generated outreach must be professional and respectful",
          "detection": "Scan generated emails for inappropriate content",
          "action": "Block sending + flag for review"
        }
      },

      "data_retention_policies": {
        "candidate_data": {
          "active_candidate": "Retain while actively recruiting (no limit)",
          "hired_candidate": "Retain 2 years post-hire (for reference checks, rehire)",
          "rejected_candidate": "Retain 1 year (for EEOC compliance, future opportunities)",
          "withdrawn_candidate": "Retain 6 months or per candidate request",
          "right_to_be_forgotten": "Delete immediately upon request (GDPR)"
        },

        "analytics_data": {
          "aggregated_metrics": "Retain indefinitely (no PII)",
          "individual_records": "Follow candidate data retention",
          "audit_logs": "Retain 7 years (compliance requirement)"
        },

        "automated_deletion": {
          "frequency": "Run monthly cleanup job",
          "process": "Identify expired data → Notify admin → Archive → Delete after 30-day grace period",
          "exceptions": "Active legal holds, investigations"
        }
      },

      "compliance_monitoring": {
        "continuous_auditing": {
          "log_all_actions": [
            "Who accessed what data when",
            "What analyses were run",
            "What decisions were made",
            "What biases were detected",
            "What searches were performed"
          ],

          "automated_checks": [
            "Adverse impact analysis (weekly)",
            "Bias detection patterns (daily)",
            "Data access anomalies (real-time)",
            "Policy violations (real-time)"
          ],

          "reporting": [
            "Monthly compliance report to admin",
            "Quarterly executive summary",
            "Annual audit trail export for legal"
          ]
        }
      }
    }
  },

  "rate_limiting": {
    "purpose": "Prevent system abuse, ensure fair usage, manage costs",

    "rate_limit_tiers": {
      "api_calls": {
        "free_tier": {
          "limits": {
            "analyses_per_day": 20,
            "web_searches_per_day": 50,
            "batch_processing_per_day": 3,
            "reports_generated_per_day": 10
          },
          "burst_allowance": "Up to 5 requests in 1 minute, then throttle",
          "overage": "Soft limit - warn user, delay requests"
        },

        "professional_tier": {
          "limits": {
            "analyses_per_day": 200,
            "web_searches_per_day": 500,
            "batch_processing_per_day": 20,
            "reports_generated_per_day": 100
          },
          "burst_allowance": "Up to 20 requests in 1 minute",
          "overage": "Allow with warning, throttle at 2x limit"
        },

        "enterprise_tier": {
          "limits": {
            "analyses_per_day": 2000,
            "web_searches_per_day": 5000,
            "batch_processing_per_day": 100,
            "reports_generated_per_day": 500
          },
          "burst_allowance": "Up to 50 requests in 1 minute",
          "overage": "Soft limits, monitoring only"
        },

        "unlimited_tier": {
          "limits": "No hard limits, monitoring for abuse only",
          "burst_allowance": "Reasonable use expected",
          "overage": "Contact customer success if excessive"
        }
      },

      "external_api_calls": {
        "web_search": {
          "provider_limits": "Respect Google/Bing rate limits",
          "ark_limits": "Max 100 searches per user per hour",
          "caching": "Cache results for 1 hour to reduce API calls",
          "fallback": "If rate limited, use cached data or alternative source"
        },

        "ats_apis": {
          "greenhouse": "100 requests per minute per account",
          "lever": "60 requests per minute per account",
          "workday": "10 requests per minute per account (conservative)",
          "handling": "Queue requests, batch when possible, retry with exponential backoff"
        },

        "email_apis": {
          "gmail": "250 emails per day (personal), 2000/day (workspace)",
          "outlook": "300 emails per day",
          "sendgrid": "Per plan limits",
          "handling": "Queue outbound emails, spread over 24 hours if bulk"
        }
      },

      "resource_limits": {
        "file_uploads": {
          "max_file_size": "25 MB per file",
          "max_files_per_upload": "50 files",
          "max_daily_uploads": "500 files per user",
          "supported_formats": ["PDF", "DOCX", "TXT", "CSV", "XLSX", "images"]
        },

        "batch_processing": {
          "max_candidates_per_batch": "100 candidates",
          "max_concurrent_batches": "3 per user",
          "processing_timeout": "5 minutes per batch",
          "queue_position": "Show user position in queue if system busy"
        },

        "report_generation": {
          "max_report_size": "50 MB",
          "max_data_points": "10,000 candidates per report",
          "export_formats": ["PDF", "Excel", "CSV", "JSON"],
          "async_for_large": "Reports >5MB generated async, emailed when ready"
        }
      }
    },

    "rate_limit_enforcement": {
      "detection": {
        "track_usage": "Count actions per user per time window",
        "identify_patterns": "Detect unusual spikes or sustained high usage",
        "categorize": "Normal use | High use | Potential abuse"
      },

      "response_strategies": {
        "soft_limit_warning": {
          "when": "User reaches 80% of limit",
          "action": "Show warning: 'You've used 16/20 daily analyses. Limit resets at midnight UTC.'",
          "purpose": "Give user awareness, no disruption"
        },

        "hard_limit_block": {
          "when": "User reaches 100% of limit",
          "action": "Block request + show: 'Daily limit reached. Upgrade to Professional for higher limits or wait until [reset time].'",
          "purpose": "Enforce fair usage"
        },

        "throttling": {
          "when": "User makes requests too rapidly",
          "action": "Delay requests: 1st = immediate, 2nd = 1s wait, 3rd = 2s wait, etc.",
          "purpose": "Prevent system overload, encourage reasonable pacing"
        },

        "temporary_suspension": {
          "when": "Potential abuse detected (e.g., bulk scraping pattern)",
          "action": "Suspend access + alert admin + require human review",
          "purpose": "Protect system and other users"
        }
      },

      "exemptions": {
        "emergency_access": "Admin can grant temporary limit increases for urgent needs",
        "scheduled_batch_jobs": "Pre-approved batch operations bypass normal limits",
        "system_integrations": "Automated workflows have separate, higher limits"
      }
    },

    "cost_management": {
      "track_costs": {
        "per_operation_cost": {
          "candidate_analysis": "$0.02",
          "web_search": "$0.01",
          "report_generation": "$0.05",
          "batch_processing": "$0.10 (up to 50 candidates)",
          "api_integrations": "$0.001 per call"
        },

        "calculate_user_cost": "Sum all operations per user per month",
        "alert_thresholds": {
          "individual_user": "Alert if user costs >$500/month (potential error or abuse)",
          "organization": "Alert if org costs >$10k/month (review usage patterns)"
        }
      },

      "cost_optimization": {
        "caching": "Cache repeated analyses, searches, reports for 1 hour",
        "deduplication": "Don't re-analyze same resume multiple times",
        "batch_optimization": "Encourage batching to reduce per-operation overhead",
        "off_peak_processing": "Run large batch jobs during off-peak hours"
      }
    }
  },

  "error_handling": {
    "purpose": "Gracefully handle failures, provide clear feedback, recover automatically when possible",

    "error_categories": {
      "user_errors": {
        "invalid_input": {
          "examples": [
            "Uploading corrupted PDF",
            "Providing incomplete JD",
            "Missing required fields"
          ],
          "handling": {
            "detect": "Validate input before processing",
            "message": "Clear, actionable error message: 'Resume PDF is corrupted. Please try a different file format.'",
            "recovery": "Suggest fixes, offer alternative formats"
          }
        },

        "unauthorized_access": {
          "examples": [
            "Trying to access data without permission",
            "Attempting admin actions as regular user"
          ],
          "handling": {
            "detect": "Check permissions before action",
            "message": "'You don't have permission to export all candidates. Please contact your admin.'",
            "recovery": "Explain how to request access"
          }
        },

        "quota_exceeded": {
          "examples": [
            "Exceeding daily analysis limit",
            "Batch too large"
          ],
          "handling": {
            "detect": "Check limits before processing",
            "message": "'Daily limit of 20 analyses reached. Resets at midnight UTC. Upgrade to Professional for 200/day.'",
            "recovery": "Show upgrade options, estimated reset time"
          }
        }
      },

      "system_errors": {
        "api_failures": {
          "examples": [
            "ATS API down",
            "Web search service unavailable",
            "Email service timeout"
          ],
          "handling": {
            "detect": "Monitor API response codes, timeouts",
            "message": "'Unable to connect to LinkedIn. Using cached data from 2 hours ago.'",
            "recovery": "Use cached data, fallback to alternative API, retry with backoff"
          }
        },

        "processing_errors": {
          "examples": [
            "Resume parsing failure",
            "Analysis timeout",
            "Memory exceeded"
          ],
          "handling": {
            "detect": "Wrap processing in try-catch, set timeouts",
            "message": "'Analysis taking longer than expected. We'll email results to you in 5 minutes.'",
            "recovery": "Queue for async processing, notify when complete"
          }
        },

        "data_integrity_errors": {
          "examples": [
            "Corrupted database entry",
            "Inconsistent data state",
            "Missing required data"
          ],
          "handling": {
            "detect": "Validate data consistency checks",
            "message": "'Data inconsistency detected. Our team has been notified.'",
            "recovery": "Alert engineering, use backup data, prevent cascade"
          }
        }
      },

      "external_errors": {
        "network_failures": {
          "examples": [
            "Internet connection lost",
            "DNS resolution failure",
            "Proxy timeout"
          ],
          "handling": {
            "detect": "Network error codes, timeouts",
            "message": "'Network connection issue. Retrying in 5 seconds...'",
            "recovery": "Retry with exponential backoff (2s, 4s, 8s, 16s), up to 5 attempts"
          }
        },

        "third_party_outages": {
          "examples": [
            "Greenhouse API down",
            "Google search unavailable",
            "Slack webhook failing"
          ],
          "handling": {
            "detect": "Monitor third-party status pages",
            "message": "'Greenhouse is experiencing an outage. Analysis will sync when service resumes.'",
            "recovery": "Queue operations, auto-retry when service restored, notify user"
          }
        }
      }
    },

    "error_handling_patterns": {
      "retry_with_backoff": {
        "when": "Transient failures (network, timeouts, rate limits)",
        "strategy": {
          "attempt_1": "Immediate retry",
          "attempt_2": "Wait 2 seconds, retry",
          "attempt_3": "Wait 4 seconds, retry",
          "attempt_4": "Wait 8 seconds, retry",
          "attempt_5": "Wait 16 seconds, retry",
          "max_attempts": 5,
          "give_up": "After 5 attempts, log error, notify user, escalate if critical"
        },
        "example": "Web search fails → Retry 5 times with backoff → If still failing, use cached data or skip"
      },

      "circuit_breaker": {
        "when": "Repeated failures indicate systemic issue",
        "strategy": {
          "monitor": "Track failure rate per service",
          "threshold": "If 5+ failures in 1 minute, open circuit",
          "open_circuit": "Stop trying that service for 5 minutes",
          "half_open": "After 5 minutes, try 1 request to test",
          "close_circuit": "If successful, resume normal operations",
          "stay_open": "If still failing, stay open for another 5 minutes"
        },
        "example": "ATS API failing repeatedly → Open circuit → Use cached candidate data instead → Test every 5 min → Resume when working"
      },

      "fallback_cascade": {
        "when": "Primary method fails, try alternatives",
        "strategy": {
          "primary": "Try best/fastest option first",
          "secondary": "If fails, try second-best option",
          "tertiary": "If fails, try third option",
          "ultimate_fallback": "Manual process or graceful degradation"
        },
        "example": {
          "task": "Get current salary data",
          "primary": "Web search (real-time, accurate)",
          "secondary": "Cached search from 24 hours ago",
          "tertiary": "Built-in salary database (last updated 6 months ago)",
          "fallback": "Provide salary range with caveat: 'Based on 6-month-old data, actual may be 10-15% higher'"
        }
      },

      "graceful_degradation": {
        "when": "Can't provide full functionality, provide partial",
        "strategy": {
          "identify_core_vs_nice_to_have": "What's essential vs optional?",
          "deliver_core": "Ensure core functionality works",
          "skip_optional": "Skip features that are failing",
          "communicate": "Tell user what's available and what's not"
        },
        "example": {
          "scenario": "GitHub API down, analyzing developer candidate",
          "full_service": "Resume analysis + GitHub portfolio analysis + code quality check",
          "degraded_service": "Resume analysis only",
          "message": "'GitHub is temporarily unavailable. Analysis based on resume only. We'll update with GitHub insights when service resumes.'"
        }
      },

      "async_processing": {
        "when": "Operation takes >30 seconds or resources constrained",
        "strategy": {
          "accept_request": "Acknowledge immediately: 'Processing your request...'",
          "queue": "Add to processing queue with priority",
          "notify": "Email/Slack when complete",
          "status_page": "Provide link to check progress"
        },
        "example": "Batch analyze 100 candidates → Queue → Process in background → Email report when done: 'Your 100-candidate analysis is complete: [link]'"
      }
    },

    "error_messages": {
      "principles": {
        "be_clear": "Explain what went wrong in plain English",
        "be_actionable": "Tell user what they can do about it",
        "be_honest": "Don't hide behind vague 'error occurred' messages",
        "be_empathetic": "Acknowledge frustration, apologize if appropriate"
      },

      "good_vs_bad_examples": {
        "bad": "Error 500: Internal server error",
        "good": "We encountered an unexpected issue while analyzing this resume. Our team has been notified. Please try again in a few minutes, or contact support if the issue persists.",

        "bad": "Invalid input",
        "good": "The resume file appears to be corrupted. Please try:\n1. Re-downloading the original file\n2. Converting to a different format (PDF or DOCX)\n3. Copying text into a plain text file",

        "bad": "Rate limit exceeded",
        "good": "You've reached your daily limit of 20 candidate analyses. Your limit resets at midnight UTC (in 8 hours). Want to upgrade to Professional for 200 analyses/day? [Upgrade] or [View Usage]",

        "bad": "Service unavailable",
        "good": "LinkedIn is temporarily unavailable. We're using cached data from 3 hours ago. Results may not reflect recent profile changes. Retrying automatically in 5 minutes."
      }
    },

    "logging_and_monitoring": {
      "log_all_errors": {
        "what_to_log": {
          "error_type": "User error | System error | External error",
          "error_message": "Detailed technical message",
          "user_message": "What user saw",
          "context": "What was being attempted, input data",
          "stack_trace": "For debugging (not shown to user)",
          "user_id": "Who encountered it",
          "timestamp": "When it occurred",
          "resolution": "How it was handled (retry, fallback, failure)"
        },

        "log_levels": {
          "debug": "Detailed info for development",
          "info": "Normal operations, successful completions",
          "warning": "Recoverable issues (used fallback, retry succeeded)",
          "error": "Failures that impacted user (show error message)",
          "critical": "System-wide failures, data integrity issues"
        }
      },

      "alerting": {
        "real_time_alerts": {
          "critical_errors": "Page on-call engineer immediately",
          "error_rate_spike": "Alert if error rate >5% for 5 minutes",
          "service_down": "Alert if any critical service unreachable for 2 minutes",
          "data_corruption": "Alert immediately"
        },

        "daily_summaries": {
          "error_count": "Total errors by type",
          "most_common_errors": "Top 10 errors",
          "affected_users": "How many users impacted",
          "resolution_rates": "How many auto-recovered vs manual fix needed"
        }
      },

      "metrics_to_track": {
        "error_rate": "Errors per 1000 requests",
        "retry_success_rate": "% of retries that succeeded",
        "fallback_usage": "How often fallbacks invoked",
        "mean_time_to_recovery": "How fast errors resolved",
        "user_impact": "% of users who encountered errors"
      }
    }
  },

  "incident_response": {
    "purpose": "Handle major outages or issues systematically",

    "incident_levels": {
      "severity_1_critical": {
        "definition": "System completely down, no workarounds, affecting all users",
        "response_time": "Immediate (5 minutes)",
        "team": "Full incident response team, executive notification",
        "communication": "Status page updated every 15 minutes, direct user notification"
      },

      "severity_2_major": {
        "definition": "Core functionality impaired, workarounds exist, affecting many users",
        "response_time": "30 minutes",
        "team": "Engineering team, customer success notified",
        "communication": "Status page updated every 30 minutes"
      },

      "severity_3_minor": {
        "definition": "Non-critical feature impaired, limited user impact",
        "response_time": "4 hours",
        "team": "Assigned engineer",
        "communication": "Status page note, resolve during business hours"
      }
    },

    "incident_process": {
      "detect": "Monitoring alerts, user reports, internal discovery",
      "declare": "Incident commander assigned, severity determined",
      "communicate": "Update status page, notify affected users",
      "investigate": "Root cause analysis, gather logs",
      "mitigate": "Implement temporary fix, reduce impact",
      "resolve": "Permanent fix deployed, tested",
      "postmortem": "Document what happened, why, how to prevent",
      "improve": "Implement prevention measures, update playbooks"
    }
  }
}
